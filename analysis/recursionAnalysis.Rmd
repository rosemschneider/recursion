---
title: "RecursionAnalysis"
author: "Junyi Chu, Rose M. Schneider, Pierina Cheung"
date: "`r Sys.Date()`"
output: github_document
---

# Setup
```{r setup, include=FALSE}
rm(list = ls())
require("knitr")

# # Set WD
 opts_knit$set(root.dir = "~/Sites/recursion/")
#opts_knit$set(root.dir = "~/Projects/Junyi study/recursiongithub/") #for PC
#opts_knit$set(root.dir = "~/Documents/Projects/recursion/") #this is specific to RMS, change accordinglyz

# For wrapping lines when knitting
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE,
               warning=FALSE)

library(Hmisc)
library(tidyverse)
library(magrittr)
#library(langcog)
library(lme4)
library(stringr)
library(RColorBrewer)
library(ggthemes)
library(memisc)

# Set seed for reproducible analyses
set.seed(42)
'%!in%' <- function(x,y)!('%in%'(x,y))

# colors
prod.pal <- c("#E41A1C", "#4DAF4A", "#377EB8")
```

R Version for citation is: `r R.version.string`.

## Loading data
```{r}
#original data
full.data <- read.csv('data/recursion_full.csv', na.strings=c(""," ","NA", "NA "))
```

Reasons for exclusion and their numbers
```{r}
full.data %>%
  dplyr::filter(ExclusionGroup != "include") %>%
  dplyr::distinct(LadlabID, .keep_all = TRUE) %>%
  dplyr::group_by(ExclusionGroup) %>%
  dplyr::summarize(countN = dplyr::n_distinct(LadlabID)) %>%
  kable()
```


RMS original code for checking who failed practice - do not need to run. EVAL set to FALSE
```{r eval = FALSE}

# check how many failed both practice trials
x <- full.data %>%
  filter(Task == "WCN" &
           (TaskItem == 1 | TaskItem == 5))%>%
  group_by(LadlabID)%>%
  summarise(sum = sum(Accuracy))%>%
  filter(sum != 2)

#just hardcoding kids because it's easier than going back to the full data frame
#These kids got 1 right, 5 wrong: 
one.corr <- as.vector(c("012316-BO", "022616-JM", "030216-ED", 
                        "030817-ZI", "031516-A", "032216-JH", 
                        "032216-RC", "040317-AL", "040317-SL", 
                        "041316-AR", "041316-NC", "041316-VN", 
                        "062416-MC"))

five.corr <- as.vector("050617-Z1")

zero.corr <- as.vector(c("030216-AD", "040616-K"))


```

Exclude those who failed the practice trials on What Comes Next Task
```{r}

#final decision: remove kids who fail 1 trial out of 2 trials, with no additional information about whether E reran the failed trial. Removing 8 kids in total

# added 022516-ML on 2018-09-03 to the exclusion list. kid had NA data for wcn practice trials and 0 correct on test. assume kid failed wcn.

full.data %<>%
  mutate(ExclusionGroup = ifelse(LadlabID == "022616-JM"| LadlabID == "030216-AD"|
                                   LadlabID == "031516-A" | LadlabID == "041316-AR"|
                                   LadlabID == "041316-VN" | LadlabID == "032216-RC"|
                                   LadlabID == "012316-BO"| LadlabID == "041316-NC"|
                                   LadlabID == "022516-ML", "fail wcn", levels(ExclusionGroup)[ExclusionGroup]),
         ExclusionGroup = as.factor(ExclusionGroup))

# check. good
# full.data %>%
#   filter(LadlabID == "022616-JM")

```

Let's remove anyone who should not be included in the final dataset.
```{r}
full.data %<>%
  dplyr::filter(ExclusionGroup == "include")

```


Now, add in the Productivity classification, IHC, and FHC from PC, JC, and RMS coding

```{r}
#productivity, fhc, ihc coding from pc, jc, and rms
hc.data <- read.csv('data/HC-datawide-forcoding - hc.datawide.csv') %>%
  dplyr::select(LadlabID, prod_tomerge, ihc_tomerge, fhc_tomerge, dce)

full.data <- dplyr::left_join(full.data, hc.data, by = "LadlabID")

full.data %<>%
  dplyr::rename(Productivity = prod_tomerge, 
                IHC = ihc_tomerge, 
                FHC = fhc_tomerge, 
                DCE = dce)%>%
  dplyr::mutate(Productivity = factor(Productivity, levels = c("nonprod", "prod"), 
                                      labels = c("Nonproductive", "Productive")), 
                IHC = ifelse(IHC > 100, 100, IHC),
                FHC = ifelse(FHC > 100, 100, FHC)) %>%
    mutate(Productivity.tertiary = ifelse(IHC >= 99, "Productive (IHC \u2265 99)", 
                             ifelse(Productivity == "Productive", "Productive (IHC < 99)", "Nonproductive")))


#do a quick check to make sure we have the same SIDs in each
unique.full <- as.vector(unique(full.data$LadlabID))
unique.hc <- as.vector(unique(hc.data$LadlabID))

tmp <- hc.data %>%
  dplyr::filter(LadlabID %!in% unique.full)

#good to go - the only kids who are not included in full data are the ones who we excluded
```

Add in coding for reminder prompts and recovery from reminders
```{r}
reminders.data <- read.csv('data/sara-HC-datawide-forcoding - hc.datawide.csv') %>%
  dplyr::select(LadlabID, reminders.total, reminders.recovered)
full.data <- dplyr::left_join(full.data, reminders.data, by="LadlabID")
```

## Post-exclusion summary
Number of kids by age group and average age
```{r}
full.data %>%
  dplyr::group_by(AgeGroup) %>%
  dplyr::summarize(sumAge = n_distinct(LadlabID)) %>%
  kable()

full.data %>%
  dplyr::distinct(LadlabID, .keep_all = TRUE) %>%
  dplyr::summarize(minAge = min(Age),
                   maxAge = max(Age),
                   meanAge = mean(Age),
                   sdAge = sd(Age)) %>%
  kable()
```

Number of kids who were classified as decade productive & nonproductive
```{r}
full.data %>%
  dplyr::distinct(LadlabID, Productivity, Age)%>%
  dplyr::group_by(Productivity)%>%
  dplyr::summarise(n = n(),
                   meanage = mean(Age, na.rm=TRUE),
                   sdage = sd(Age, na.rm=TRUE),
                   minage = min(Age, na.rm=TRUE),
                   maxage = max(Age, na.rm=TRUE)) %>%
  kable()
```

Number of kids for the 3-way productivity classification
```{r}
full.data %>%
  dplyr::distinct(LadlabID, Productivity.tertiary, Age)%>%
  dplyr::group_by(Productivity.tertiary)%>%
  dplyr::summarise(n = n(),
                   meanage = mean(Age, na.rm=TRUE),
                   sdage = sd(Age, na.rm=TRUE),
                   minage = min(Age, na.rm=TRUE),
                   maxage = max(Age, na.rm=TRUE)) %>%
  kable()
```

Just for reference, this is the number of kids who switched classifications from PC, JC, RMS recode
```{r}
full.data %>%
  dplyr::filter(TaskType == "productivity") %>%
  droplevels()%>%
  dplyr::distinct(LadlabID, Response, Productivity) %>%
  dplyr::mutate(Response = factor(Response, levels = c("nonprod", "prod"), 
                                  labels = c("Nonproductive", "Productive")))%>%
  dplyr::mutate(changed_classification = ifelse((is.na(Response) & Productivity == "Nonproductive"),
                                                "NA_toNonprod",
                                                ifelse((is.na(Response) & Productivity == "Productive"), 
                                                       "NA_toProd", 
                                                       ifelse((Response == "Nonproductive" & Productivity == "Productive"), 
                                                              "Nonprod_toProd", 
                                                              ifelse((Response == "Productive" & Productivity == "Nonproductive"),
                                                                     "Prod_toNonprod", "no_change")))))%>%
  dplyr::group_by(changed_classification)%>%
  dplyr::summarise(n =n())
```

## Productivity gradient
```{r}
full.data %<>%
  mutate(delta.hc = FHC-IHC, 
         prod.gradient = delta.hc/(99-IHC), 
         prod.gradient = ifelse(IHC >= 99, 1, as.numeric(prod.gradient)), 
         prod.gradient = ifelse(prod.gradient == 0 & IHC == 99, 1, as.numeric(prod.gradient)))
```

***
# Highest Count Descriptives
Average of IHC, DCE, and FHC for all kids
```{r}
full.data %>%
  dplyr::distinct(LadlabID, IHC)%>%
  dplyr::summarise(mean_IHC = mean(IHC),
                   sd_IHC = sd(IHC),
                   min_IHC = min(IHC),
                   max_IHC = max(IHC),
                   median_IHC = median(IHC)) %>%
  kable()

full.data %>%
  dplyr::distinct(LadlabID, DCE)%>%
  dplyr::summarise(mean_DCE = mean(DCE, na.rm=TRUE),
                   sd_DCE = sd(DCE, na.rm=TRUE),
                   min_DCE = min(DCE, na.rm=TRUE),
                   max_DCE = max(DCE, na.rm=TRUE),
                   median_DCE = median(DCE, na.rm=TRUE)) %>%
  kable()

full.data %>%
  dplyr::distinct(LadlabID, FHC)%>%
  dplyr::summarise(mean_FHC = mean(FHC),
                   sd_FHC = sd(FHC),
                   min_FHC = min(FHC),
                   max_FHC = max(FHC),
                   median_FHC = median(FHC)) %>%
  kable()

#productivity gradient
full.data %>%
  distinct(LadlabID, delta.hc, prod.gradient)%>%
  summarise(mean_gradient = mean(prod.gradient), 
            sd_gradient = sd(prod.gradient), 
            mean_delta.hc = mean(delta.hc), 
            sd_delta.hc = sd(delta.hc))%>%
  kable()
```

Similar data by decade productivity
```{r}
full.data %>%
  dplyr::distinct(LadlabID, Productivity, IHC)%>%
  dplyr::group_by(Productivity)%>%
  dplyr::summarise(mean_IHC = mean(IHC),
                   sd_IHC = sd(IHC),
                   min_IHC = min(IHC),
                   max_IHC = max(IHC),
                   median_IHC = median(IHC)) %>%
  kable()

full.data %>%
  dplyr::distinct(LadlabID, Productivity, DCE)%>%
  dplyr::group_by(Productivity)%>%
  dplyr::summarise(mean_DCE = mean(DCE, na.rm=TRUE),
                   sd_DCE = sd(DCE, na.rm=TRUE),
                   min_DCE = min(DCE, na.rm=TRUE),
                   max_DCE = max(DCE, na.rm=TRUE),
                   median_DCE = median(DCE, na.rm=TRUE)) %>%
  kable()

full.data %>%
  dplyr::distinct(LadlabID, Productivity, FHC)%>%
  dplyr::group_by(Productivity)%>%
  dplyr::summarise(mean_FHC = mean(FHC),
                   sd_FHC = sd(FHC),
                   min_FHC = min(FHC),
                   max_FHC = max(FHC),
                   median_FHC = median(FHC)) %>%
  kable()

#productivity gradient
full.data %>%
  distinct(LadlabID, Productivity, delta.hc, prod.gradient)%>%
  group_by(Productivity)%>%
  summarise(mean_gradient = mean(prod.gradient), 
            sd_gradient = sd(prod.gradient), 
            mean_delta.hc = mean(delta.hc), 
            sd_delta.hc = sd(delta.hc))%>%
  kable()
```

Again by 3-way decade productivity
```{r}
full.data %>%
  dplyr::distinct(LadlabID, Productivity.tertiary, IHC)%>%
  dplyr::group_by(Productivity.tertiary)%>%
  dplyr::summarise(mean_IHC = mean(IHC),
                   sd_IHC = sd(IHC),
                   min_IHC = min(IHC),
                   max_IHC = max(IHC),
                   median_IHC = median(IHC)) %>%
  kable()

full.data %>%
  dplyr::distinct(LadlabID, Productivity.tertiary, DCE)%>%
  dplyr::group_by(Productivity.tertiary)%>%
  dplyr::summarise(mean_DCE = mean(DCE, na.rm=TRUE),
                   sd_DCE = sd(DCE, na.rm=TRUE),
                   min_DCE = min(DCE, na.rm=TRUE),
                   max_DCE = max(DCE, na.rm=TRUE),
                   median_DCE = median(DCE, na.rm=TRUE)) %>%
  kable()

full.data %>%
  dplyr::distinct(LadlabID, Productivity.tertiary, FHC)%>%
  dplyr::group_by(Productivity.tertiary)%>%
  dplyr::summarise(mean_FHC = mean(FHC),
                   sd_FHC = sd(FHC),
                   min_FHC = min(FHC),
                   max_FHC = max(FHC),
                   median_FHC = median(FHC)) %>%
  kable()

#productivity gradient
full.data %>%
  distinct(LadlabID, Productivity.tertiary, delta.hc, prod.gradient)%>%
  group_by(Productivity.tertiary)%>%
  summarise(mean_gradient = mean(prod.gradient), 
            sd_gradient = sd(prod.gradient), 
            mean_delta.hc = mean(delta.hc), 
            sd_delta.hc = sd(delta.hc))%>%
  kable()
```

Plotting distribution of IHC, as a function of productivity (~ junyi's graph)

```{r}
unique.hc.data <- full.data %>%
  dplyr::distinct(LadlabID, Gender, Age, AgeGroup, HCReceivedSupport, IHC, DCE, FHC, Productivity, Productivity.tertiary)

ggplot(unique.hc.data, aes(x=IHC, color=Productivity)) + 
  geom_dotplot(aes(fill = Productivity),
               binwidth=1, stackgroups=TRUE, binpositions="all",method="dotdensity", dotsize = 1) +
  scale_color_brewer(palette="Set1") + 
  scale_fill_brewer(palette="Set1") +
  coord_fixed(ratio=1) +
  scale_y_continuous(breaks=seq(0,40,10), lim=c(0,35)) +
  scale_x_continuous(breaks=seq(0,100,by=10)) +
  labs(x="IHC", 
       y="Frequency") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom", 
        legend.title = element_blank(), 
        panel.grid.minor = element_blank())
ggsave('graphs/ihc-by-prod.png')

## three-way productivity
ggplot(unique.hc.data, aes(x=IHC, color=Productivity.tertiary)) + 
  geom_dotplot(aes(fill = Productivity.tertiary),
               binwidth=1, stackgroups=TRUE, binpositions="all",method="dotdensity", dotsize = 1) +
  scale_color_manual(values=prod.pal, name="Productivity") + 
  scale_fill_manual(values=prod.pal, name="Productivity") +
  coord_fixed(ratio=1) +
  scale_y_continuous(breaks=seq(0,40,10), lim=c(0,35)) +
  scale_x_continuous(breaks=seq(0,100,by=10)) +
  labs(x="IHC", 
       y="Frequency") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom", 
        legend.title = element_blank(), 
        panel.grid.minor = element_blank())
ggsave('graphs/ihc-by-prod2.png')

## Black graph for talk purposes
ggplot(unique.hc.data, aes(x=IHC)) + 
  geom_dotplot(binwidth=1, stackgroups=TRUE, binpositions="all",method="dotdensity", dotsize = 1) +
  coord_fixed(ratio=1) +
  scale_y_continuous(breaks=seq(0,40,10), lim=c(0,35)) +
  scale_x_continuous(breaks=seq(0,100,by=10)) +
  labs(x="IHC", 
       y="Frequency") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom", 
        legend.title = element_blank(), 
        panel.grid.minor = element_blank())
ggsave('graphs/ihc.png')
```

Plotting productivity as a function of age in months

```{r}
unique.hc.data$AgeMonths = floor(unique.hc.data$Age*12)

ggplot(unique.hc.data, aes(x=AgeMonths, colour = Productivity)) + 
  geom_dotplot(aes(fill = Productivity),
               binwidth = 1,
               stackgroups=TRUE, binpositions="all") +
  coord_fixed(ratio=1) +
  scale_y_continuous(breaks=seq(0,10,5), lim=c(0,12)) +
  scale_x_continuous(breaks=seq(48,72,by=6)) +
  scale_color_brewer(palette="Set1") + 
  scale_fill_brewer(palette="Set1") +
  labs( x="Age in Months", 
       y="Frequency") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom")
ggsave('graphs/prod-by-age.png')

```

## Distance between IHC and FHC

Restructure data to plot distance between IHC, DCE, and FHC
```{r}
hc.dev.data <- full.data %>%
  dplyr::select(LadlabID, Age, Productivity, IHC, DCE, FHC, prod.gradient) %>%
  gather(hcprogression, hc, IHC:FHC)%>%
  mutate(hcprogression = factor(hcprogression, levels = c("IHC", "DCE", "FHC"))) %>%
  dplyr::rename(`Highest Count Coding` = hcprogression)

#all kids together
# ggplot(hc.dev.data, aes(x = LadlabID, y = hc)) + 
#   facet_grid(rows = vars(Productivity)) +
#   geom_line(data=hc.dev.data[!is.na(hc.dev.data$hc),]) + 
#   geom_point(aes(shape = `Highest Count Coding`, colour = `Highest Count Coding`), 
#              size = 2, stroke = 1.5) +
#   scale_color_brewer(palette="Dark2") +
#   scale_shape_manual(values = c(4,5,20)) +
#   labs(title="Highest Count Progression by Decade Productivity",
#        x = "Each line = individual participant",
#        y="Highest Count by Count Type") +
#   theme_bw(base_size = 13) + 
#   theme(legend.position="bottom", 
#         axis.text.x = element_text(angle = 270, hjust = 1)) +
#   theme(axis.text.x=element_blank(),
#         axis.ticks.x=element_blank()) 

hc.dev.prod <- subset(hc.dev.data, Productivity == "Productive")
hc.dev.nonprod <- subset(hc.dev.data, Productivity == "Nonproductive")
```


Separate graphs for productivity groups (for easier viewing)
```{r eval=FALSE, include=FALSE}
#productive
ggplot(hc.dev.prod, aes(x = LadlabID, y = hc)) + 
  facet_grid(rows = vars(Productivity)) +
  geom_line(data=hc.dev.prod[!is.na(hc.dev.prod$hc),]) + 
  geom_point(aes(shape = `Highest Count Coding`, colour = `Highest Count Coding`), 
             size = 2, stroke = 1.5) +
  scale_color_brewer(palette="Dark2") +
  scale_shape_manual(values = c(4,5,20)) +
  ylim(0, 100) +
  labs(title="A. Distance, Productive Decade Counters",
       x = "Each line = individual participant",
       y="Highest Count") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom", 
        axis.text.x = element_text(angle = 270, hjust = 1)) + 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave('graphs/distance-prod.png')

#nonproductive
ggplot(hc.dev.nonprod, aes(x = LadlabID, y = hc)) + 
  facet_grid(rows = vars(Productivity)) +
  geom_line(data=hc.dev.nonprod[!is.na(hc.dev.nonprod$hc),]) + 
  geom_point(aes(shape = `Highest Count Coding`, colour = `Highest Count Coding`), 
             size = 2, stroke = 1.5) +
  scale_color_brewer(palette="Dark2") +
  scale_shape_manual(values = c(4,5,20)) +
  ylim(0, 100) +
  labs(title="B. Distance, Non-productive Decade Counters",
       x = "Each line = individual participant",
       y="Highest Count") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom", 
        axis.text.x = element_text(angle = 270, hjust = 1)) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave('graphs/distance-nonprod.png')

```

### Fig 2a/b
Separate graphs for productivity groups, sorted by ascending IHC
```{r}
#productive
ggplot(hc.dev.prod, aes(x = reorder(LadlabID, hc, FUN=min), y = hc)) + 
  facet_grid(rows = vars(Productivity)) +
  geom_line(data=hc.dev.prod[!is.na(hc.dev.prod$hc),]) + 
  geom_point(aes(shape = `Highest Count Coding`, colour = `Highest Count Coding`), 
             size = 2, stroke = 1.5) +
  scale_color_brewer(palette="Dark2", labels=c("Initial Highest Count", "Decade-Change Error", "Final Highest Count")) +
  scale_shape_manual(values = c(4,5,20), labels=c("Initial Highest Count", "Decade-Change Error", "Final Highest Count")) +
  ylim(0, 100) +
  labs(title="a. Distance, Productive Decade Counters",
       x = "Each line = individual participant",
       y="Highest Count",
       colour="Highest Count Coding",
       shape="Highest Count Coding") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom", 
        #axis.text.x = element_text(angle = 270, hjust = 1),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave('graphs/distance-prod-sorted.png', width=8, height=4)

#nonproductive
ggplot(hc.dev.nonprod, aes(x = reorder(LadlabID, hc, FUN=min), y = hc)) + 
  facet_grid(rows = vars(Productivity)) +
  geom_line(data=hc.dev.nonprod[!is.na(hc.dev.nonprod$hc),]) + 
  geom_point(aes(shape = `Highest Count Coding`, colour = `Highest Count Coding`), 
             size = 2, stroke = 1.5) +
  scale_color_brewer(palette="Dark2", labels=c("Initial Highest Count", "Decade-Change Error", "Final Highest Count")) +
  scale_shape_manual(values = c(4,5,20), labels=c("Initial Highest Count", "Decade-Change Error", "Final Highest Count")) +
  ylim(0, 100) +
  labs(title="b. Distance, Non-productive Decade Counters",
       x = "Each line = individual participant",
       y="Highest Count",
       colour="Highest Count Coding",
       shape="Highest Count Coding") +
  theme_bw(base_size = 13) + 
  theme(legend.position="bottom", 
        #axis.text.x = element_text(angle = 270, hjust = 1),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) 
ggsave('graphs/distance-nonprod-sorted.png', width=8, height=4)

```

Number of kids who counted to 99+ spontaneously on IHC plus those whose FHC = 99+ without prompting
```{r}
# full.data %>%
#   filter(IHC > 98) %>%
#   distinct(LadlabID, IHC, FHC, HCReceivedSupport) %>%
#   count() #n=32
# but some kids made errors past IHC but < 3 so need to account for that
full.data %>%
  filter(FHC > 98 & (is.na(HCReceivedSupport)|HCReceivedSupport != 1)) %>%
  distinct(LadlabID, IHC, FHC, HCReceivedSupport) %>%
  count() #n =42

```

## Decade prompts
Average number of decade prompts provided. Productive counters first
```{r}
full.data %>%
  filter(TaskItem == "times") %>%
  filter(Productivity == "Productive") %>%
  distinct(LadlabID, HCReceivedSupport, TaskItem, Response) %>%
  mutate(Response = as.numeric(levels(Response)[Response])) %>%
  group_by(HCReceivedSupport) %>%
  summarize(mean = mean(Response, na.rm=TRUE),
            sd = sd(Response, na.rm=TRUE),
            min = min(Response, na.rm=TRUE),
            max = max(Response, na.rm=TRUE),
            count=n())
# assume 0 = NA
# error in supported.times coding, should only count to 90
# but one kid got prompted with 100 and 110 and times should be 0

```


Then nonproductive counters.
```{r}
full.data %>%
  filter(TaskItem == "times") %>%
  filter(Productivity == "Nonproductive") %>%
  distinct(LadlabID, HCReceivedSupport, TaskItem, Response) %>%
  mutate(Response = as.numeric(levels(Response)[Response])) %>%
  group_by(HCReceivedSupport) %>%
  summarize(mean = mean(Response, na.rm=TRUE),
            sd = sd(Response, na.rm=TRUE),
            min = min(Response, na.rm=TRUE),
            max = max(Response, na.rm=TRUE),
            count=n())
# assume 0 = NA
# error in supported.times coding, should only count to 90
# but one kid got prompted with 100 and 110 and times should be 0
```

## Reminder prompts
How many kids have coded data for receiving reminders?
```{r}
full.data %>%
  dplyr::select(LadlabID, Productivity, reminders.total, reminders.recovered) %>%
  unique()%>%
  na.omit() %>%
  summarise(Ncoded=n(), 
            total.min=min(reminders.total),
            total.max=max(reminders.total),
            total.mean=mean(reminders.total),
            total.median=median(reminders.total))
```

How often did kids miss a reminder? Remember that the experiment ended when kids failed to recover from a reminder, unless that failure occured at a decade transition in which case the experimenter would provide a decade prompt and continue the experiment. 
```{r}
full.data %>%
  dplyr::select(LadlabID, Productivity, reminders.total, reminders.recovered) %>%
  unique()%>%
  na.omit() %>%
  mutate(missed = reminders.total-reminders.recovered) %>%
  summarise(Ncoded=n(), 
            missed.min=min(missed),
            missed.max=max(missed),
            missed.mean=mean(missed),
            missed.median=median(missed))
# look at proportion of kids who failed to recover from reminders.
full.data %>%
  dplyr::select(LadlabID, Productivity, reminders.total, reminders.recovered) %>%
  unique()%>%
  na.omit() %>%
  mutate(missed = reminders.total-reminders.recovered) %>%
  group_by(reminders.total) %>%
  summarise(Nkids=n(),N.kids.missed=sum(missed),Perc.kids.missed=sum(missed)/n())
```


# What Comes Next Descriptives

<span style="color:red">Note minimum highest contig NN can be 5 (one of the practice trials). Practice trials are excluded from %corr and within vs. beyond computation.</span>

First check if Accuracy column in full.data is coded correctly. Good to go.
```{r}
wcn.data <- full.data %>%
  filter(Task == "WCN")

wcn.data %<>%
  mutate(Response_num = as.numeric(as.character(Response)), 
         TaskItem_num = as.numeric(as.character(TaskItem)), 
         Accuracy_check = ifelse(Response_num == (TaskItem_num + 1), 1, 0), 
         Accuracy_valid = ifelse(Accuracy == Accuracy_check, TRUE, FALSE))

validate <- function(){
  validation <- wcn.data %>%
    filter(Accuracy_valid == FALSE)
  if(length(validation$LadlabID) > 0) {
    print("WARNING: CHECK CODING")
  } else {
    print("All coding correct")
  }
}

validate()
```

Add overall accuracy to the dataframe.
```{r}
wcn.accuracy <- wcn.data %>% 
    filter(TaskType != "practice") %>%
  filter(TaskType == "immediate") %>%
  group_by(LadlabID) %>%
  mutate(wcnscore=sum(Accuracy, na.rm = TRUE)) %>%
  dplyr::select(LadlabID, wcnscore) %>%
  unique()
```

Immediate vs. Momentum trials: Children were provided with momentum trials if they got wrong on immediate trials. Check %trials where immediate = wrong, momentum = right
```{r}
wcn.wide <- full.data %>%
  filter(ExclusionGroup == "include") %>%
  filter(Task == "WCN") %>%
  filter(TaskType != "practice") %>%
  filter(TaskItem != 3) %>% # a trial on 3 for momentum that doesn't exist for immediate
  droplevels()%>%
  dplyr::select(LadlabID, Age, AgeGroup, TaskType, TaskItem, Accuracy, Productivity, prod.gradient) %>%
  spread(TaskType, Accuracy)

# data check: some kids got 1 for immediate but 0 for momentum or 1 for immediate and 1 for momentum (N = 5).Keeping them. 
## for reference, pulling out these kids below
full.data %>%
  filter(Task == "WCN", 
         TaskType == "momentum" | TaskType == "immediate")%>%
  dplyr::select(LadlabID, Age, AgeGroup, TaskType, TaskItem, Accuracy) %>%
  spread(TaskType, Accuracy)%>%
  mutate(issue_immediate1Momentum0 = ifelse(immediate == 1 & momentum == 0, TRUE, FALSE), 
         issue_immediate1Momentum1 = ifelse(immediate == 1 & momentum == 1, TRUE, FALSE))%>%
  filter(issue_immediate1Momentum0 == TRUE | 
           issue_immediate1Momentum1 == TRUE)

# how many kids show improved performance
xtabs(~immediate + momentum, data = wcn.wide, na.action = na.pass, exclude = NULL)
# 191 / 1048 trials = ~ 18%. NOTE % not by kids but by trials.
```

## Percent Correct on WCN
```{r}
wcn.data %>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(LadlabID) %>%
  dplyr::summarize(avg.wcn = mean(Accuracy, na.rm=TRUE),
                   sd.wcn = sd(Accuracy, na.rm=TRUE)) %>%
  dplyr::summarize(avg = mean(avg.wcn),
                   sd = sd(sd.wcn))

wcn.data %>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(LadlabID, Productivity) %>%
  dplyr::summarize(avg.wcn = mean(Accuracy, na.rm=TRUE),
                   sd.wcn = sd(Accuracy, na.rm=TRUE)) %>%
  dplyr::group_by(Productivity) %>%
  dplyr::summarize(avg = mean(avg.wcn),
                   sd = sd(sd.wcn))
```

Plotting %corr on WCN as function of productivity
```{r}
wcn.data %>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(LadlabID, Productivity, prod.gradient) %>%
  dplyr::summarize(avg.wcn = mean(Accuracy, na.rm=TRUE),
                   sd.wcn = sd(Accuracy, na.rm=TRUE)) %>%
  ggplot(aes(x = Productivity, y = avg.wcn, fill=factor(Productivity))) +
  stat_summary(fun.y = mean, position = position_dodge(width = .95), 
               geom="bar", alpha = .8, colour = "black") +
  geom_violin(alpha = .3) +
  stat_summary(fun.data = mean_se, geom="errorbar", 
               position = position_dodge(width=0.90), width = 0.2)+
  #scale_fill_discrete(name = "Productivity") +
  scale_fill_brewer(name = "Productivity", palette = "Set1", guide = "none") +
  scale_colour_brewer(palette = "Greys") +
  ylab("Proportion Correct") + 
  xlab('Productivity') + 
  theme_bw(base_size = 13) + 
  theme(legend.position = "none", 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  theme(text = element_text(size = 12)) +
  ylim(0, 1.0) 
  
  
ggsave('graphs/wcn-percentcorr.png')


```

### Fig 3
Jess graph
```{r fig3}
wcn.data <- wcn.data

fig3.data <- wcn.data %>%
  filter(TaskType == "immediate")%>%
  mutate(TaskItem_type= ifelse(mod(TaskItem_num,10)==9, "Decade transition", "Mid-decade")) %>%
  mutate(TaskItem_type_ordered = ordered(TaskItem_type, levels=c("Mid-decade", "Decade transition")))

fig3.data %>%
  group_by(TaskItem_type_ordered, TaskItem, Productivity.tertiary)%>%
   summarise(mean = mean(Accuracy, na.rm = TRUE), 
            n = n(), 
            sd = sd(Accuracy, na.rm = TRUE), 
            se = sd/sqrt(n)) %>%
  ggplot(aes(x = factor(TaskItem), y = mean, colour = Productivity.tertiary, group= Productivity.tertiary)) +
  geom_point(size = 2.5) + 
  geom_line(size = .7) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), 
                width = 0, size = .5) +
  facet_grid(~TaskItem_type_ordered, scales = "free_x") +#, space = "free_x") +
  theme_bw(base_size = 13) + 
  scale_colour_manual(values = prod.pal) +
  theme(legend.position = "right", legend.title = element_blank()) +
  labs(x = "Task item", y = "Mean performance") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
        #, strip.text=element_text(margin=margin(t=5, b=5, l=20, r=20)))
ggsave('graphs/wcn-trial-accuracy.png')
```

Productive (IHC<99) vs. Nonproductive on NN accuracy
```{r}
# Only for productive IHC < 99 and nonproductive
fig3.model.df <- fig3.data %>%
  filter(Productivity.tertiary != "Productive (IHC \u2265 99)") %>%
  dplyr::select(c(LadlabID, IHC, FHC, Age, Productivity.tertiary,
                  TaskItem_num, TaskItem_type, Accuracy)) %>%
  mutate(IHC = as.integer(IHC),
         LadlabID=as.factor(LadlabID),
         Productivity.tertiary=as.factor(Productivity.tertiary),
         TaskItem_type=as.factor(TaskItem_type))%>%
  mutate(IHC.c = as.vector(scale(IHC, center = TRUE, scale=TRUE)), #scale and center for model fit
         FHC.c = as.vector(scale(FHC, center = TRUE, scale=TRUE)), 
         age.c = as.vector(scale(Age, center = TRUE, scale=TRUE)))
str(fig3.model.df)

# means by item type
fig3.model.df %>%
  group_by(LadlabID, TaskItem_type) %>%
  summarise(score=mean(Accuracy, na.rm=T)) %>%
  ungroup() %>%
  group_by(TaskItem_type) %>%
  summarise(mean=mean(score, na.rm=T), sd=sd(score, na.rm=T), n=n())
# means by productivity
fig3.model.df %>%
  group_by(LadlabID, Productivity.tertiary) %>%
  summarise(score=mean(Accuracy, na.rm=T)) %>%
  ungroup() %>%
  group_by(Productivity.tertiary) %>%
  summarise(mean=mean(score, na.rm=T), sd=sd(score, na.rm=T), n=n())

```


### Analyses of Figure 3 data
```{r}
##WCN model looking at interaction between productivity and decade/non-decade item accuracy
fig3.model.base <- glmer(Accuracy ~ age.c + 
                           (1|TaskItem_num) + (1|LadlabID),
                         family = "binomial", data = fig3.model.df)
fig3.model.ihc <- glmer(Accuracy ~ IHC.c + age.c + 
                          (1|TaskItem_num) + (1|LadlabID), 
                       family = "binomial", data = fig3.model.df)
fig3.model.prod <- glmer(Accuracy ~ Productivity.tertiary + IHC.c + age.c + 
                           (1|TaskItem_num) + (1|LadlabID), 
                       family = "binomial", data = fig3.model.df)
fig3.model.itemtype <- glmer(Accuracy ~ Productivity.tertiary + TaskItem_type+ IHC.c + age.c +
                            (1|TaskItem_num) + (1|LadlabID), 
                       family = "binomial", data = fig3.model.df)
fig3.model.full <- glmer(Accuracy ~ Productivity.tertiary + TaskItem_type +
                           Productivity.tertiary:TaskItem_type + IHC.c + age.c + 
                           (1|TaskItem_num) + (1|LadlabID), 
                       family = "binomial", data = fig3.model.df)
# LRT tests
drop1(fig3.model.itemtype,test="Chisq")

#comparison of models
anova(fig3.model.full, fig3.model.itemtype, fig3.model.prod, fig3.model.ihc, fig3.model.base, test = 'LRT')


# summary of final model
summary(fig3.model.itemtype)

# random effects
# ranef(fig3.model.prod)

# visualization

# library(effects)
# fig3.model.noint.df <- as.data.frame(allEffects(fig3.model.noint)[[2]])
# ggplot(fig3.model.noint.df,
#        aes(x=TaskItem_type,y=fit,ymin=lower,ymax=upper)) + 
#     geom_pointrange(position=position_dodge(width=.1)) 
```

### Analyses including all participants
```{r}
fig3.model2.df <- fig3.data %>%
  dplyr::select(c(LadlabID, IHC, FHC, Age, Productivity.tertiary,
                  TaskItem_num, TaskItem_type, Accuracy)) %>%
  mutate(IHC = as.integer(IHC),
         LadlabID=as.factor(LadlabID),
         Productivity.tertiary=as.factor(Productivity.tertiary),
         TaskItem_type=as.factor(TaskItem_type))%>%
  mutate(IHC.c = as.vector(scale(IHC, center = TRUE, scale=TRUE)), #scale and center for model fit
         FHC.c = as.vector(scale(FHC, center = TRUE, scale=TRUE)), 
         age.c = as.vector(scale(Age, center = TRUE, scale=TRUE)))
str(fig3.model2.df)

# means by item type
fig3.model2.df %>%
  group_by(LadlabID, TaskItem_type) %>%
  summarise(score=mean(Accuracy, na.rm=T)) %>%
  ungroup() %>%
  group_by(TaskItem_type) %>%
  summarise(mean=mean(score, na.rm=T), sd=sd(score, na.rm=T), n=n())
# means by productivity
fig3.model2.df %>%
  group_by(LadlabID, Productivity.tertiary) %>%
  summarise(score=mean(Accuracy, na.rm=T)) %>%
  ungroup() %>%
  group_by(Productivity.tertiary) %>%
  summarise(mean=mean(score, na.rm=T), sd=sd(score, na.rm=T), n=n())

## regressions
fig3.model2.noint <- glmer(Accuracy ~ Productivity.tertiary + TaskItem_type+ 
                             IHC.c + age.c + 
                             (1|TaskItem_num) + (1|LadlabID), 
                           family = "binomial", data = fig3.model2.df)
fig3.model2.full <- glmer(Accuracy ~ Productivity.tertiary + TaskItem_type +
                            Productivity.tertiary:TaskItem_type +
                         IHC.c + age.c + 
                             (1|TaskItem_num) + (1|LadlabID), 
                           family = "binomial", data = fig3.model2.df)
#comparison of models
anova(fig3.model2.full, fig3.model2.noint, test = 'LRT')

# LRT tests
drop1(fig3.model2.noint,test="Chisq")

# summary of full model
summary(fig3.model2.noint)

# random effects
#ranef(fig3.model.prod)

# visualization
library(effects)
fig3.model.full.df <- as.data.frame(allEffects(fig3.model.full)[[3]])
ggplot(fig3.model.full.df,
       aes(x=TaskItem_type,y=fit,color=Productivity.tertiary, ymin=lower,ymax=upper)) + 
    geom_pointrange(position=position_dodge(width=.1)) 
```



## Within / Outside IHC
Add whether the Task Item was within or outside of the kid's initial highest count.
```{r}
#first, get initial highest count for each kiddo
#Make a lookup table with SID and initial highest count
lookup <- full.data %>%
  distinct(LadlabID, IHC)

wcn.data %<>%
  dplyr::mutate(TaskItem = as.numeric(as.character(TaskItem)))

#This is a function that, for each trial, checks the number queried. If number queried is above the child's initial highest count, marks that trial as beyond count range.
determine_count_range <- function(df) {
  tmp <- df
  for (row in 1:nrow(tmp)) {
    sub = as.character(tmp[row, "LadlabID"])
    count_range = as.numeric(as.character(subset(lookup, LadlabID == sub)$IHC))
    tmp[row, "IHC"] = as.numeric(as.character(count_range))
    if (tmp[row, "TaskItem"] > count_range) {
      tmp[row, "WithinOutsideIHC"] = "outside"
    } else {
      tmp[row, "WithinOutsideIHC"] = "within"
    }
  }
  return(tmp)
}

#Run for wcn
wcn.data <- determine_count_range(wcn.data)
```

WCN accuracy, within and outside of IHC
```{r}
wcn.data %>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(LadlabID, WithinOutsideIHC) %>%
  dplyr::summarize(score=mean(Accuracy, na.rm=T)) %>%
  ungroup() %>% group_by(WithinOutsideIHC) %>%
  dplyr::summarize(mean = mean(score, na.rm = TRUE), 
                   sd = sd(score, na.rm = TRUE))
```


Now WCN by within/outside count range and productivity
```{r}
wcn.data %>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(LadlabID, Productivity, WithinOutsideIHC) %>%
  dplyr::summarize(score=mean(Accuracy, na.rm=T)) %>%
  ungroup() %>% group_by(Productivity, WithinOutsideIHC) %>%
  dplyr::summarize(mean = mean(score, na.rm = TRUE), 
                   sd = sd(score, na.rm = TRUE))

# three-way
wcn.data %>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(LadlabID, Productivity.tertiary, WithinOutsideIHC) %>%
  dplyr::summarize(score=mean(Accuracy, na.rm=T)) %>%
  ungroup() %>% group_by(Productivity.tertiary, WithinOutsideIHC) %>%
  dplyr::summarize(mean = mean(score, na.rm = TRUE), 
                   sd = sd(score, na.rm = TRUE))
```


Plotting WCN as within vs. beyond by productivity 
### Fig 4

```{r}
group_names <- c(`Productive` = "Productive Counters",
                    `Nonproductive` = "Nonproductive Counters")
# alternative 2, use fewer colors.
wcn.data %>%
  mutate(WithinOutsideIHC = factor(WithinOutsideIHC, levels = c("within", "outside"), 
                                   labels = c("Within IHC", "Beyond IHC")))%>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(Productivity, WithinOutsideIHC, LadlabID, prod.gradient) %>%
  dplyr::summarize(meansubj = mean(Accuracy, na.rm = TRUE)) %>%
  ggplot(aes(x=WithinOutsideIHC, y=meansubj))+
  geom_violin(aes(color=Productivity), alpha=0.7, scale="count", position=position_dodge(width=0.8)) +
  geom_point(aes(fill=WithinOutsideIHC),
             position=position_jitterdodge(jitter.width=0.25,
                                           dodge.width=.9),
             alpha = .5) +
  stat_summary(aes(color=Productivity),
               fun.data = mean_cl_boot, geom="errorbar",
               position = position_dodge(width=0.8), width = 0.2)+
  stat_summary(aes(color=Productivity), fill="white",
               fun.y = mean,position = position_dodge(width=0.8), 
               geom="point", shape=23, size=3)+
  facet_grid(.~Productivity, labeller = as_labeller(group_names)) +
  scale_colour_brewer(guide=FALSE, palette="Set1") + 
  scale_fill_brewer(guide=FALSE) +
  scale_y_continuous(limits=c(0,1)) +
  labs(y="Average Proportion Correct", x="Trial Type") +
  theme_bw(base_size = 13) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

ggsave('graphs/wcn-within-beyond-final.png', width=6, height=4)
```

Same graph but three-way productvity grouping
```{r}
# alternative 2, use fewer colors.
wcn.data %>%
  mutate(WithinOutsideIHC = factor(WithinOutsideIHC, levels = c("within", "outside"), 
                                   labels = c("Within IHC", "Beyond IHC")))%>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(Productivity.tertiary, WithinOutsideIHC, LadlabID, prod.gradient) %>%
  dplyr::summarize(meansubj = mean(Accuracy, na.rm = TRUE)) %>%
  ggplot(aes(x=WithinOutsideIHC, y=meansubj))+
  geom_violin(aes(color=Productivity.tertiary), alpha=0.7, scale="count", position=position_dodge(width=0.8)) +
  geom_point(aes(fill=WithinOutsideIHC),
             position=position_jitterdodge(jitter.width=0.25,
                                           dodge.width=.9),
             alpha = .5) +
  stat_summary(aes(color=Productivity.tertiary),
               fun.data = mean_cl_boot, geom="errorbar",
               position = position_dodge(width=0.8), width = 0.2)+
  stat_summary(aes(color=Productivity.tertiary), fill="white",
               fun.y = mean,position = position_dodge(width=0.8), 
               geom="point", shape=23, size=3)+
  facet_grid(.~Productivity.tertiary, scales="free") +
  scale_colour_brewer(guide=FALSE, palette="Set1") + 
  scale_fill_brewer(guide=FALSE) +
  scale_y_continuous(limits=c(0,1)) +
  labs(y="Average Proportion Correct", x="Trial Type") +
  theme_bw(base_size = 13) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

ggsave('graphs/wcn-within-beyond-finalb.png', width=8, height=4)
```

Try without violins
```{r}
## HM? 
wcn.data %>%
  mutate(WithinOutsideIHC = factor(WithinOutsideIHC, levels = c("within", "outside"), 
                                   labels = c("Within IHC", "Beyond IHC")))%>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(Productivity.tertiary, WithinOutsideIHC, LadlabID, prod.gradient) %>%
  dplyr::summarize(meansubj = mean(Accuracy, na.rm = TRUE)) %>%
  ggplot(aes(x=WithinOutsideIHC, y=meansubj)) +
  stat_summary(aes(color=Productivity.tertiary),
               fun.data = mean_cl_boot, geom="errorbar",
               width = 0.2)+
  stat_summary(aes(color=Productivity.tertiary), fill="white",
               fun.y = mean,
#               position = position_dodge(width=0.8), 
               geom="point", shape=23, size=3) +
  stat_summary(fun.y="mean", geom="line", aes(color=Productivity.tertiary,
                                              group=factor(Productivity.tertiary))) +
      scale_colour_manual(values=prod.pal, name="Productivity") + 
  scale_fill_brewer(guide=FALSE) +
  scale_y_continuous(limits=c(0,1)) +
  labs(y="Average Proportion Correct", x="Trial Type") +
  theme_bw(base_size = 13) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
ggsave('graphs/wcn-within-beyond-finalc.png', width=6, height=4)
```

```{r}
# Alternative
wcn.data %>%
  mutate(WithinOutsideIHC = factor(WithinOutsideIHC, levels = c("within", "outside"), 
                                   labels = c("Within IHC", "Beyond IHC")))%>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(Productivity, WithinOutsideIHC, LadlabID, prod.gradient) %>%
  dplyr::summarize(meansubj = mean(Accuracy, na.rm = TRUE)) %>%
  ggplot(aes(x=Productivity, y=meansubj))+
  geom_violin(aes(color=Productivity), alpha=0.7, scale="count", position=position_dodge(width=0.8)) +
  geom_point(aes(fill=Productivity),
             position=position_jitterdodge(jitter.width=0.25,
                                           dodge.width=.9),
             alpha = .4) +
  stat_summary(aes(color=Productivity),
               fun.data = mean_cl_boot, geom="errorbar",
               position = position_dodge(width=0.8), width = 0.2)+
  stat_summary(aes(color=Productivity), fill="white",
               fun.y = mean,position = position_dodge(width=0.8), 
               geom="point", shape=23, size=3)+
  facet_wrap(.~WithinOutsideIHC, strip.position="bottom") +
  scale_colour_brewer(palette="Set1", direction=-1) + 
  scale_y_continuous(limits=c(0,1)) +
  labs(y="Average Proportion Correct", x="Trial Type") +
  theme_bw(base_size = 13) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank())
ggsave('graphs/wcn-within-beyond4.png', width=6, height=4)

```

#### Analysis for fig 4
Analysis of WCN accuracy by productivity and trial type
```{r}
# wcn_score.df <- wcn.data %>%
#   dplyr::filter(TaskType == "immediate") %>%
#   dplyr::group_by(LadlabID, Productivity, TrialType=as.factor(WithinOutsideIHC)) %>%
#   dplyr::summarize(correct = sum(Accuracy, na.rm = TRUE), total=n())
# 
wcn_model.df <- wcn.data %>%
  filter(TaskType == "immediate")%>%
  mutate(IHC = as.integer(IHC),
         LadlabID = factor(LadlabID))%>%
  mutate(IHC.c = as.vector(scale(IHC, center = TRUE, scale=TRUE)), #scale and center for model fit
         FHC.c = as.vector(scale(FHC, center = TRUE, scale=TRUE)), 
         age.c = as.vector(scale(Age, center = TRUE, scale=TRUE)))

##WCN model looking at interaction between productivity and trial type in WCN task
wcn.model.base <- glmer(Accuracy ~ age.c + (1|TaskItem_num) + (1|LadlabID), 
                        family = "binomial", data = wcn_model.df)
wcn.model.ihc <- glmer(Accuracy ~ IHC.c + age.c + (1|TaskItem_num) + (1|LadlabID), 
                       family = "binomial", data = wcn_model.df)
wcn.model.noint <- glmer(Accuracy ~ Productivity + WithinOutsideIHC + 
                           IHC.c + age.c + (1|TaskItem_num) +
                     (1|LadlabID), family = "binomial", data = wcn_model.df)
wcn.model.int <- glmer(Accuracy ~ Productivity + WithinOutsideIHC + 
                         Productivity:WithinOutsideIHC + 
                         IHC.c + age.c + (1|TaskItem_num) +
                     (1|LadlabID), family = "binomial", data = wcn_model.df)

#comparison of models
anova(wcn.model.int, wcn.model.noint, wcn.model.ihc, wcn.model.base, test = 'LRT')
anova(wcn.model.int, wcn.model.ihc, wcn.model.base, test = 'LRT')

# summary of final model
drop1(wcn.model.int,test="Chisq")
summary(wcn.model.int)

```


#### analysis removing IHC=99
```{r}
wcn_model.df2 <- wcn_model.df %>%
    filter(Productivity.tertiary != "Productive (IHC \u2265 99)")

##WCN model looking at interaction between productivity and trial type in WCN task
wcn.model2.base <- glmer(Accuracy ~ age.c + (1|TaskItem) + (1|LadlabID), 
                        family = "binomial", data = wcn_model.df2)
wcn.model2.ihc <- glmer(Accuracy ~ IHC.c + age.c + (1|TaskItem) + (1|LadlabID), 
                       family = "binomial", data = wcn_model.df2)
wcn.model2.noint <- glmer(Accuracy ~ Productivity + WithinOutsideIHC + IHC.c + age.c + (1|TaskItem) +
                     (1|LadlabID), family = "binomial", data = wcn_model.df2)
wcn.model2.int <- glmer(Accuracy ~ Productivity+ WithinOutsideIHC + 
                         Productivity:WithinOutsideIHC + IHC.c + age.c + (1|TaskItem) +
                     (1|LadlabID), family = "binomial", data = wcn_model.df2)

#comparison of models
anova(wcn.model2.int, wcn.model2.noint, wcn.model2.ihc, wcn.model2.base, test = 'LRT')

# summary of final model
summary(wcn.model2.int)
```

How many trials do kids have beyond their IHC?
```{r}
wcn.data %>%
  dplyr::filter(TaskType == "immediate") %>%
  dplyr::group_by(Productivity, WithinOutsideIHC)%>%
  dplyr::summarise(n = n())
```

## Highest contiguous NN

```{r message=FALSE, warning=FALSE}
wcn.wide %<>%
  dplyr::mutate(TaskItem = as.numeric(as.character(TaskItem)))

unique.nn <- as.vector(unique(wcn.wide$LadlabID))
#get the task items from wcn
nextnums <- as.vector(unique(wcn.wide$TaskItem))

#this is a function that pulls out the largest number for which a participant had a correct consecutive
get_contiguous <- function(){
  contig <- data.frame()
  for (sub in unique.nn) {
    tmp <- wcn.wide %>%
      dplyr::select(LadlabID, Age, AgeGroup, TaskItem, immediate)%>%
      filter(LadlabID == sub, 
             immediate == 0)%>%
      mutate(TaskItem = sort(TaskItem))
    if (length(tmp$LadlabID) == 0) {
      highest_contig = 86
      sub_contig <- data.frame(sub, highest_contig)
      contig <- bind_rows(contig, sub_contig)
    } else if (length(tmp$TaskItem) > 0 & min(tmp$TaskItem) == 23) {
      #if(sub %in% one.corr){
      highest_contig = 5
      sub_contig <- data.frame(sub, highest_contig)
      contig <- bind_rows(contig, sub_contig)
      # } else if(sub %in% five.corr | sub %in% zero.corr){
      #   highest_contig = 0
      #   sub_contig <- data.frame(sub, highest_contig)
      #   contig <- bind_rows(contig, sub_contig)
      # } else {
      #   highest_contig = 5
      #   sub_contig <- data.frame(sub, highest_contig)
      #   contig <- bind_rows(contig, sub_contig)
      # }
    } else {
      min.nn <- min(tmp$TaskItem)
      prev_correct <- nextnums[nextnums < min.nn]
      highest_contig <- max(prev_correct)
      
      sub_contig <- data.frame(sub,
                               highest_contig)
      contig <- bind_rows(contig, sub_contig)
    }
  }
  return(contig)
}

highest_contiguous_nn <- get_contiguous()%>%
  dplyr::rename(LadlabID = sub)%>%
  distinct(LadlabID, highest_contig)%>%
  dplyr::rename(Highest_Contig_NN = highest_contig)

#add highest contiguous to wcn.data
wcn.data <- full_join(wcn.data, highest_contiguous_nn, by = "LadlabID")

```

Code for checking highest contig NN
```{r eval = FALSE}
full.data %>%
  # filter(LadlabID == "022316-AB") %>%
  filter(TaskType == "immediate"|TaskType == "practice") %>%
  dplyr::select(LadlabID, TaskType, TaskItem, Accuracy)

# these two kids, for example, had the same contig highest NN but diff profile of responses
#040317-KK #7 correct out of 10
#022316-AB #9 correct out of 10


# wcn.data %<>%
#   dplyr::right_join(highest_contiguous_nn) 
# 
# wcn.data %>%
#   filter(LadlabID == "040317-KK")

```

See if highest contiguous next number underestimates kids' knowledge. Seems to correspond well with # correct data.
```{r}
wcn.data %>%
  dplyr::filter(TaskType == "immediate"|TaskType == "practice") %>% #added prac for 1&5
  dplyr::group_by(LadlabID, Highest_Contig_NN) %>%
  dplyr::summarize(n_corr = sum(Accuracy, na.rm = TRUE)) %>%
  dplyr::group_by(Highest_Contig_NN, n_corr) %>%
  dplyr::summarize(n_participants = n_distinct(LadlabID)) %>%
  tidyr::spread(n_corr, n_participants) %>%
  kable()


# 2 kids had NA as n_corr
wcn.data %>%
  dplyr::filter(TaskType == "immediate"|TaskType == "practice") %>% #added prac for 1&5
  dplyr::group_by(LadlabID, Highest_Contig_NN) %>%
  dplyr::summarize(n_corr = sum(Accuracy)) %>%
  dplyr::group_by(Highest_Contig_NN, n_corr) %>%
  filter(is.na(n_corr))
# 022516-ML
# 040317-SL

# this kid (ML) got 0 for all test and NA for 1 and 5. Not one of the two kids under zero.corr because kid's sum is NA. Now excluded up top.

# commentout
# full.data %>%
#   filter(LadlabID == "022516-ML") %>%
#   filter(TaskType == "immediate"|TaskType == "practice") %>%
#   select(LadlabID, TaskType, TaskItem, Accuracy)

# this kid (SL) has one NA value but otherwise look fine
# now added na.rm=TRUE for sum(accuracy)

# commentout
# full.data %>%
#   filter(LadlabID == "040317-SL") %>%
#   filter(TaskType == "immediate"|TaskType == "practice") %>%
#   select(LadlabID, TaskType, TaskItem, Accuracy)

# overview of highest contiguous coding and by-trial performance
z <- wcn.data %>%
  dplyr::right_join(highest_contiguous_nn) %>%
  filter(TaskType == "immediate") %>%
  dplyr::select(LadlabID, Highest_Contig_NN, TaskItem, Accuracy) %>%
  spread(TaskItem, Accuracy)
```

#### Test of medians
Median highest contiguous next number by productivity -- all kids
```{r}
wcn.data.bysubject<- wcn.data %>%
  dplyr::distinct(LadlabID, Highest_Contig_NN, Productivity, IHC)
wcn.data.bysubject %>%
  dplyr::group_by(Productivity) %>%
  dplyr::summarise(n = n(),
                   median_NN = median(Highest_Contig_NN),
                   mean_NN = mean(Highest_Contig_NN)) %>%
  kable()

# independent 2-group Mann-Whitney U Test 
# wilcox.test(continuous variable ~ binary factor)
wilcox.test(wcn.data.bysubject$Highest_Contig_NN
            ~ wcn.data.bysubject$Productivity, paired=FALSE) 
```


Median highest contiguous next number by productivity  - minus kids who counted to 99 spontaneously
```{r}
wcn.data.bysubject %>%
  filter(IHC < 99)%>%
  dplyr::group_by(Productivity) %>%
  dplyr::summarise(n = n(),
                   median_NN = median(Highest_Contig_NN),
                   mean_NN = mean(Highest_Contig_NN)) %>%
  kable()
# independent 2-group Mann-Whitney U Test 
# wilcox.test(continuous variable ~ binary factor)
wilcox.test(wcn.data.bysubject[wcn.data.bysubject$IHC<99,]$Highest_Contig_NN
            ~ wcn.data.bysubject[wcn.data.bysubject$IHC<99,]$Productivity) 
```

#### Histogram
Plotting freq of highest contiguous as a function of productivity
```{r}
# full.data %>%
#   dplyr::right_join(highest_contiguous_nn) %>%
#   dplyr::distinct(LadlabID, Highest_Contig_NN, Productivity) %>%
#   ggplot(aes(x=Highest_Contig_NN, color=Productivity)) + 
#   geom_dotplot(aes(fill = Productivity),
#                binwidth=1, stackgroups=TRUE, binpositions="all",method="dotdensity") +
#   scale_color_brewer(palette="Set1") + 
#   scale_fill_brewer(palette="Set1") +
#   coord_fixed(ratio=1) +
#   scale_y_continuous(breaks=seq(0,50,10), lim=c(0,50)) +
#   #scale_x_continuous(breaks=seq(0,100,by=10)) +
#   scale_x_continuous(breaks = c(0, 1, 5, 23, 29, 37, 40, 62, 70, 86),
#                      labels=c("0", "1", "5", "23", "29", "37", "40", "62", "70", "86")) +
#   labs(x="Highest Contiguous Next Number", 
#        y="Frequency") +
#   theme_bw() + 
#   theme(legend.position="bottom")
# ggsave('graphs/highestcontig-by-prod.png')

# side by side
full.data %>%
  dplyr::right_join(highest_contiguous_nn) %>%
  dplyr::distinct(LadlabID, Highest_Contig_NN, Productivity) %>%
  ggplot(aes(x=Highest_Contig_NN, color=Productivity)) + 
  geom_dotplot(aes(fill = Productivity),
               binwidth=1, stackdir="up", position=position_dodge(width=2), stackgroups=FALSE, binpositions="all",method="dotdensity") +
  scale_color_brewer(palette="Set1") + 
  scale_fill_brewer(palette="Set1") +
  coord_fixed(ratio=1) +
  scale_y_continuous(breaks=seq(0,30,10), lim=c(0,30)) +
  #scale_x_continuous(breaks=seq(0,100,by=10)) +
  scale_x_continuous(breaks = c(0, 1, 5, 23, 29, 37, 40, 62, 70, 86),
                     labels=c("0", "1", "5", "23", "29", "37", "40", "62", "70", "86")) +
  labs(x="Highest Contiguous Next Number", 
       y="Frequency") +
  theme_bw() + 
  theme(legend.position="bottom")
ggsave('graphs/highestcontig-by-prod-2.png')
```


#### Correlations
```{r}
corrdf <- full.data %>%
  dplyr::right_join(highest_contiguous_nn) %>%
  dplyr::right_join(wcn.accuracy) %>%
  dplyr::distinct(LadlabID, Highest_Contig_NN, wcn.score, prod.gradient, Age, IHC, FHC) %>%
  dplyr::select(-LadlabID)

rcorr(as.matrix(corrdf), type = "pearson")
```


# Infinity Descriptives

Number of kids in each infinity category
```{r}
# Code the categories
full.data <- full.data %>% 
  mutate(Category = case_when(
    SuccessorKnower==0 & EndlessKnower==0 ~ "A Non-knower",
    SuccessorKnower==0 & EndlessKnower==1 ~ "B Endless-only",
    SuccessorKnower==1 & EndlessKnower==0 ~ "C Successor-only",
    SuccessorKnower==1 & EndlessKnower==1 ~ "D Full-knower"
  ))

full.data %>%
  dplyr::distinct(LadlabID, Category, Productivity)%>%
  dplyr::group_by(Productivity, Category)%>%
  dplyr::summarise(n = n())

classification.data <- full.data %>%
  dplyr::distinct(LadlabID, EndlessKnower, SuccessorKnower, Productivity)

#Successor contingency table
table(classification.data$SuccessorKnower, classification.data$Productivity)
chisq.test(table(classification.data$SuccessorKnower, classification.data$Productivity))

#Endless contingency table
table(classification.data$EndlessKnower, classification.data$Productivity)
chisq.test(table(classification.data$EndlessKnower, classification.data$Productivity))

# Cross tab
table(classification.data$SuccessorKnower, classification.data$EndlessKnower)
```

Average age of kids for Endless and Successor Knowers
```{r}
full.data %>%
  dplyr::distinct(LadlabID, SuccessorKnower, Age)%>%
  dplyr::group_by(SuccessorKnower)%>%
  dplyr::summarise(meanAge = mean(Age),
                   sdAge = sd(Age),
                   meanAgeMonths = mean(Age)*12,
                   sdAgeMonths = sd(Age)*12)

full.data %>%
  dplyr::distinct(LadlabID, EndlessKnower, Age)%>%
  dplyr::group_by(EndlessKnower)%>%
  dplyr::summarise(meanAge = mean(Age),
                   sdAge = sd(Age),
                   meanAgeMonths = mean(Age)*12,
                   sdAgeMonths = sd(Age)*12)

```

Infinity in relation to highest count
```{r}
full.data %>%
  dplyr::distinct(LadlabID, EndlessKnower, IHC, FHC) %>%
  dplyr::group_by(EndlessKnower) %>%
  dplyr::summarize(mean_IHC = mean(IHC),
                   mean_FHC = mean(FHC))

full.data %>%
  dplyr::distinct(LadlabID, SuccessorKnower, IHC, FHC) %>%
  dplyr::group_by(SuccessorKnower) %>%
  dplyr::summarize(mean_IHC = mean(IHC),
                   mean_FHC = mean(FHC))
```

Infinity in relation to WCN
```{r}
full.data %>%
  dplyr::right_join(highest_contiguous_nn) %>%
  dplyr::distinct(LadlabID, EndlessKnower, Highest_Contig_NN) %>%
  dplyr::group_by(EndlessKnower) %>%
  dplyr::summarize(mean_contig_nn = mean(Highest_Contig_NN),
                   median_contig_nn = median(Highest_Contig_NN))


full.data %>%
  dplyr::right_join(highest_contiguous_nn) %>%
  dplyr::distinct(LadlabID, SuccessorKnower, Highest_Contig_NN) %>%
  dplyr::group_by(SuccessorKnower) %>%
  dplyr::summarize(mean_contig_nn = mean(Highest_Contig_NN),
                   median_contig_nn = median(Highest_Contig_NN))



```

# Productivity gradient

```{r}
ggplot(full.data, aes(x = IHC, y= prod.gradient, colour = Productivity)) +
  geom_point(size = 3, alpha = .1)+
  geom_jitter()+
  theme_bw(base_size = 13) +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  scale_colour_brewer(palette = "Set1") + 
  labs(y = 'Productivity Gradient', x = 'IHC')
```

## Correlation between productivity gradient and IHC/FHC
```{r}
ms.cor <- full.data %>%
  distinct(LadlabID, Age, IHC, FHC, prod.gradient)

cor.test(ms.cor$IHC, ms.cor$prod.gradient) #sig. correlation between IHC and prod. gradient
cor.test(ms.cor$FHC, ms.cor$prod.gradient) #sig. correlation between FHC and prod. gradient

```

## Correlation between Productivity classification and Prod.gradient
```{r}
ms.cor <- full.data %>%
  dplyr::distinct(LadlabID, Productivity, prod.gradient)%>%
  mutate(Productivity = factor(Productivity, levels = c("Productive", "Nonproductive"),
                             labels = c(1, 0)), 
         Productivity = as.integer(as.character(Productivity)))

cor.test(ms.cor$Productivity, ms.cor$prod.gradient)
```


***

# Infinity Regression Analyses
## Counting, Productivity, and Infinity Battery
To identify whether there is connection between counting experience and Infinity Task performance, we will conduct three initial analyses, predicting Infinity Task performance from either (1) Initial Highest Count, (2) Productivity for Decade Rule (defined above), or (3) performance on the Next Number task. 

glm(inf.0/1 ~ (predictor) + age, family = binomial).

---
First, we need to make a model data frame that readily has all of this information

```{r}
#model base
model.df <- full.data %>%
  dplyr::select(LadlabID, Age, AgeGroup, Gender, Task, Response, SuccessorKnower, EndlessKnower, 
                IHC, FHC, DCE, Productivity, Productivity.tertiary, prod.gradient)
```


Add highest contiguous next number and wcn accuracy to model.df 
```{r}
model.df <- right_join(model.df, highest_contiguous_nn, by = "LadlabID")

model.df <- right_join(model.df, wcn.accuracy, by="LadlabID")
```


## Successor models
```{r}
#each participant only needs one row here, because we only need to know whether they are a Successor Knower or Endless Knower
distinct_model.df <- model.df %>%
  distinct(LadlabID, Age, AgeGroup, Gender, SuccessorKnower, EndlessKnower, 
           IHC, Highest_Contig_NN, FHC, DCE, Productivity, Productivity.tertiary, prod.gradient, wcnscore)%>%
  mutate(SuccessorKnower = factor(SuccessorKnower, levels = c(0,1)), 
         EndlessKnower = factor(EndlessKnower, levels = c(0,1)),
         IHC = as.integer(IHC), 
         Highest_Contig_NN = as.integer(Highest_Contig_NN), 
         LadlabID = factor(LadlabID), 
         IHC.c = as.vector(scale(IHC, center = TRUE, scale=TRUE)), #scale and center for model fit
         FHC.c = as.vector(scale(FHC, center = TRUE, scale=TRUE)),
         Highest_Contig_NN.c = as.vector(scale(Highest_Contig_NN, center = TRUE, scale=TRUE)), 
         Age.c = as.vector(scale(Age, center = TRUE, scale=TRUE)),
         prod.gradient.c = as.vector(scale(prod.gradient, center=TRUE, scale=TRUE)),
          wcnscore.c = as.vector(scale(wcnscore, center = TRUE, scale=TRUE)))

# #add mean_nn to model df
# distinct_model.df <- right_join(distinct_model.df, lookup, by = "LadlabID")

###MODEL BUILDING AND COMPARISONS###
#base model for successor knower
base.successor <- glm(SuccessorKnower ~ Age.c, family = "binomial", 
                        data = distinct_model.df)

##IHC model##
model.ihc.successor <- glm(SuccessorKnower ~ IHC.c + Age.c, family = "binomial", 
                             data = distinct_model.df)
##Highest NN Model##
model.nn.successor <- glm(SuccessorKnower ~ Highest_Contig_NN.c + Age.c, family = "binomial", 
                            data = distinct_model.df)
##Productivity model##
model.prod.successor <- glm(SuccessorKnower ~ Productivity + Age.c, family = "binomial",
                              data = distinct_model.df)

##EXPLORATORY## - GAIN SCORE
model.gain.successor <- glm(SuccessorKnower ~ prod.gradient.c + Age.c, family = "binomial",
                              data = distinct_model.df)
summary(model.gain.successor)

##Regression table for Successor Knower Models (Table 2)
mtable.sf.knowers <- mtable('Base' = base.successor,
            'IHC' = model.ihc.successor,
            'Highest Contig.' = model.nn.successor,
            'Productivity' = model.prod.successor,
            'Exp. - Prod. gain' = model.gain.successor,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))
mtable.sf.knowers
write.mtable(mtable.sf.knowers, file="graphs/table2.txt")

###MODEL COMPARISONS##
#base v. IHC
anova(base.successor, model.ihc.successor, test = 'LRT') #IHC not significant

#Highest contiguous NN v. IHC
anova(base.successor, model.nn.successor, test = 'LRT')#highest contiguous NN not significant

#Productivity v. IHC
anova(base.successor, model.prod.successor, test = 'LRT')#Productivity trending


##Exploratory
anova(base.successor, model.gain.successor, test = 'LRT')
```


## Endless Models
```{r}
#Base model
base.endless <- glm(EndlessKnower ~ Age.c, family = "binomial", 
                      data = distinct_model.df)

###IHC MODEL###
model.ihc.endless <- glm(EndlessKnower ~ IHC.c + Age.c, family = "binomial", 
                           data = distinct_model.df)

###HIGHEST CONTIG NN MODEL###
model.nn.endless <- glm(EndlessKnower ~ Highest_Contig_NN.c + Age.c, family = "binomial", 
                          data = distinct_model.df) 

###PRODUCTIVITY MODEL###
model.prod.endless <- glm(EndlessKnower ~ Productivity + Age.c, family = "binomial", 
                            data = distinct_model.df)

##EXPLORATORY## - GAIN SCORE
model.gain.endless <- glm(EndlessKnower ~ prod.gradient.c + Age.c, family = "binomial", 
                          data = distinct_model.df)

##Regression table for Endless Models
mtable.endless.knowers <- mtable('Base' = base.endless,
            'IHC' = model.ihc.endless,
            'Highest Contig.' = model.nn.endless,
            'Productivity' = model.prod.endless,
            'Prod. gradient' = model.gain.endless,
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','F','p','N'))

mtable.endless.knowers
write.mtable(mtable.endless.knowers, file="graphs/table3.txt")

##SIMPLE MODEL COMPARISONS##
#base v. IHC
anova(base.endless, model.ihc.endless, test = 'LRT') #IHC significant

#base v. highest contiguous
anova(model.nn.endless, base.endless, test = 'LRT')#Highest contig NN significant

#base v. productivity
anova(model.prod.endless, base.endless, test = 'LRT')#Prod significant

##Exploratory base v. productivity gradient
anova(base.endless, model.gain.endless, test = 'LRT')# prod. gradient significant (better than IHC)

# #okay with about mean NN
# model2.endless <- glmer(EndlessKnower ~ mean.NN + Age + (1|LadlabID), family = "binomial", 
#                         data = distinct_model.df)
# anova(model2.endless, base.endless, test = 'LRT')#mean NN significant
```

### Endless: Large model comparison
Put all significant Endless predictors into large model, run model comparison

```{r}
##BASE MODEL WITH IHC
large.endless.base <- glm(EndlessKnower ~ IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)
##add highest contig
large.endless.nn <- glm(EndlessKnower ~ Highest_Contig_NN.c + IHC.c + Age.c, 
                          family = "binomial", data = distinct_model.df)

##Productivity + IHC
large.endless.prod <- glm(EndlessKnower ~ Productivity + IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)

##Prod. Gain + IHC
large.endless.gain.ihc <- glm(EndlessKnower ~ IHC.c + prod.gradient.c + Age.c, 
                              family = "binomial", data = distinct_model.df)
#summary(large.endless.gain.ihc) #with addition of IHC, prod.gradient is marginal, AIC very slightly decreases

##ALL THREE TOGETHER
large.endless.full <- glm(EndlessKnower ~ Productivity + Highest_Contig_NN.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)

##ALL THREE (productivity gradient)
large.endless.full.grad <- glm(EndlessKnower ~ prod.gradient.c + Highest_Contig_NN.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)


##MODEL COMPARISONS
#IHC v. Highest contig.
anova(large.endless.base, large.endless.nn, test = 'LRT')#Highest contig. NS

#IHC v. Productivity
anova(large.endless.base, large.endless.prod, test = 'LRT')##Productivity NS

#IHC v. Prod. Gain
anova(large.endless.base, large.endless.gain.ihc, test = 'LRT') #n.s. addition of gradient to ihc
anova(model.gain.endless, large.endless.gain.ihc, test = 'LRT') #n.s. addition of ihc to gradient.
```

### Endless: regression table
```{r}
mtable.endless.large <- mtable(#'IHC alone' = large.endless.base,
            'HCNN + IHC' = large.endless.nn,
            'Prod.Group + IHC' = large.endless.prod,
#            'Prod.Group + Highest contig. + IHC' = large.endless.full,
#            'Prod.Gradient alone' = model.gain.endless,
            'Prod.Gradient + IHC' = large.endless.gain.ihc,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))

mtable.endless.large
write.mtable(mtable.endless.large, file="graphs/table3b.txt")
```
 
 
## LM predicting IHC from productivity and age, HCNN and age
```{r}
lm.prod <- full.data %>%
  distinct(LadlabID, Productivity, Age, IHC)%>%
  mutate(Age.c = as.vector(scale(Age, center = TRUE, scale=TRUE)))

lm1 <- lm(IHC ~ Productivity + Age.c, data = lm.prod)
summary(lm1)


lm2 <- lm(IHC ~ Highest_Contig_NN + Age.c, data = distinct_model.df)
summary(lm2)
```

## Full Infinity Knowledge models
### build models
```{r}
# Add full infinity knowledge classification to data frame
distinct_model.df <- distinct_model.df %>%
  mutate(InfinityKnower = factor(
    case_when(SuccessorKnower==0 | EndlessKnower==0 ~ 0,
              SuccessorKnower==1 & EndlessKnower==1 ~ 1),
    levels=c(0,1))
  )

###MODEL BUILDING AND COMPARISONS###
#base model for successor knower
base.infinity <- glm(InfinityKnower ~ Age.c, family = "binomial", 
                        data = distinct_model.df)

##IHC model
model.ihc.infinity <- glm(InfinityKnower ~ IHC.c + Age.c, family = "binomial", 
                             data = distinct_model.df)
##Highest NN Model
model.nn.infinity <- glm(InfinityKnower ~ Highest_Contig_NN.c + Age.c, family = "binomial", 
                            data = distinct_model.df)
##Productivity model
model.prod.infinity <- glm(InfinityKnower ~ Productivity + Age.c, family = "binomial",
                              data = distinct_model.df)

##Gain Score model
model.gain.infinity <- glm(InfinityKnower ~ prod.gradient.c + Age.c, family = "binomial",
                              data = distinct_model.df)

##Regression table for Infinity Knower Models (Table 4)
mtable.inf.knowers <- mtable('Base' = base.infinity,
            'IHC' = model.ihc.infinity,
            'Highest Contig.' = model.nn.infinity,
            'Prod. Group' = model.prod.infinity,
            'Prod. Gain' = model.gain.infinity,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))
mtable.inf.knowers
# save as txt
write.mtable(mtable.inf.knowers, file="graphs/table4.txt")
```

### Simple comparison
```{r}
#base v. IHC
anova(base.infinity, model.ihc.infinity, test = 'LRT') #n.s.

#base v. highest contiguous
anova(base.infinity, model.nn.infinity, test = 'LRT')#n.s.

#base v. productivity
anova(base.infinity, model.prod.infinity, test = 'LRT')#n.s. 

#base v. productivity gradient
anova(base.infinity, model.gain.infinity, test = 'LRT')#n.s.
```
### 

#Exploratory - Infinity regressions IHC<99
```{r}
explore.dat <- distinct_model.df %>%
  filter(IHC < 99)


# Successor
lt99.succ.base <- glm(SuccessorKnower ~ Age.c, family = "binomial", data = explore.dat)
lt99.succ.ihc <- glm(SuccessorKnower ~ IHC.c + Age.c, family = "binomial", data = explore.dat)
lt99.succ.prod <- glm(SuccessorKnower ~ Productivity + Age.c, family = "binomial", data = explore.dat)
lt99.succ.nn <- glm(SuccessorKnower ~Highest_Contig_NN + Age.c, family = "binomial", data = explore.dat)

# Endless
lt99.end.base <- glm(EndlessKnower ~ Age.c, family = "binomial", data = explore.dat)
lt99.end.ihc <- glm(EndlessKnower ~ IHC.c + Age.c, family = "binomial", data = explore.dat)
lt99.end.prod <- glm(EndlessKnower ~ Productivity + Age.c, family = "binomial", data = explore.dat)
lt99.end.nn <- glm(EndlessKnower ~Highest_Contig_NN + Age.c, family = "binomial", data = explore.dat)

```


#Plot of prod. gain with IHC - WIP
```{r fig2}
# pg.ms <- full.data %>%
#   distinct(LadlabID, IHC, FHC, prod.gradient, Productivity)
# 
# ggplot(pg.ms, aes(x=IHC, y = prod.gradient, colour = Productivity)) +
#   geom_point(size = 2) +
#   scale_x_continuous(breaks = seq(0, 100, 10)) +
#   scale_colour_brewer(palette = "Set1") +
#   theme_bw(base_size = 13) +
#   theme(panel.grid.minor = element_blank(), 
#         legend.position = "bottom", 
#         legend.title =  element_blank())

ms <- hc.dev.data %>%
  filter(Productivity == "Productive")


hc.dev.data %>%
  filter(Productivity == "Productive")%>%
  filter(`Highest Count Coding` != "DCE")%>%
ggplot(aes(x = reorder(LadlabID, hc, FUN=min), y = hc, colour = prod.gradient)) + 
  geom_point(aes(shape = `Highest Count Coding`), 
             size = 1.2, stroke = 1.2) +
  geom_line() + 
  # scale_color_brewer(palette="Dark2") +
  scale_shape_manual(values = c(5, 20)) +
  scale_y_continuous(breaks = seq(0, 140, 10)) +
  labs(x = "Each line = individual participant",
       y="Highest Count") +
  theme_bw() + 
  theme(legend.position="bottom", 
        axis.text.x = element_text(angle = 270, hjust = 1)) + 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.grid.major = element_blank()) +
  # scale_colour_gradient(low = "#666666",
  #                       high = "#00b8e6") +
  labs(shape = "Highest Count Type", colour = "Productivity Gradient")
```


# WIP- How often do children recover from reminder prompts? 
```{r}

```

# TODO: Visualizing the regressions
```{r regression-graphs}
# visualization
library(effects)
# endless knowers
plot(allEffects(large.endless.full),
     axes=list(y=list(type="response",lab="P(Endless Knower)")))

plot(allEffects(large.endless.full.grad),
          axes=list(y=list(type="response",lab="P(Endless Knower)")))

# Successor
##ALL THREE TOGETHER
large.successor.full <- glm(SuccessorKnower ~ Productivity + Highest_Contig_NN.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)
plot(allEffects(large.successor.full),
     axes=list(y=list(type="rescale",lab="P(Successor Knower)")))

##ALL THREE (productivity gradient)
large.successor.full.grad <- glm(SuccessorKnower ~ prod.gradient.c + Highest_Contig_NN.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)
plot(allEffects(large.successor.full.grad),
          axes=list(y=list(type="rescale",lab="P(Successor Knower)")))


# full infinity
large.inf.full <- glm(InfinityKnower ~ Productivity + Highest_Contig_NN.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)
plot(allEffects(large.inf.full),
          axes=list(y=list(type="rescale",lab="P(Full Infinity)")))

##ALL THREE (productivity gradient)
large.inf.full.grad <- glm(InfinityKnower ~ prod.gradient.c + Highest_Contig_NN.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)
plot(allEffects(large.inf.full.grad),
          axes=list(y=list(type="rescale",lab="P(Full Infinity)")))
```

```{r sjsviz, warning=FALSE}
library(sjPlot)
library(sjlabelled)
library(sjmisc)
theme_set(theme_sjplot())

# best endless model
plot_model(large.endless.gain.ihc, type="std", transform="plogis",
           title="'Numbers do not end'",
           show.values = TRUE, colors="blue", value.offset = .2,
           axis.labels = c("Age.c"="Age", "Highest_Contig_NN.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-endless-partial.png', width=6, height=3)

# maximal endless model
plot_model(large.endless.full.grad, type="std", transform="plogis",
           title="'Numbers do not end'",
           show.values = TRUE, colors="blue", value.offset = .2,
           axis.labels = c("Age.c"="Age", "Highest_Contig_NN.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-endless.png', width=6, height=3.5)

# maximal successor model
plot_model(large.successor.full.grad, type="std", transform="plogis",
           title="'Can always add one'",
           show.values = TRUE, colors="blue",value.offset = .2,
           axis.labels = c("Age.c"="Age", "Highest_Contig_NN.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-successor.png', width=6, height=3.5)

# maximal infinity model
plot_model(large.inf.full.grad, type="std", transform="plogis",
           title="Full infinity knowledge",
           show.values = TRUE, colors="blue",value.offset = .2,
           axis.labels = c("Age.c"="Age", "Highest_Contig_NN.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-fullinfinity.png', width=6, height=3.5)

```


# Regressions no hcnn
Use NN accuracy instead of hcnn.

## Successor models
```{r}
###MODEL BUILDING AND COMPARISONS###
#base model for successor knower
base.successor2 <- glm(SuccessorKnower ~ Age.c, family = "binomial", 
                        data = distinct_model.df)

##IHC model##
model.ihc.successor2 <- glm(SuccessorKnower ~ IHC.c + Age.c, family = "binomial", 
                             data = distinct_model.df)
##Highest NN Model##
model.nn.successor2 <- glm(SuccessorKnower ~ wcnscore.c + Age.c, family = "binomial", 
                            data = distinct_model.df)
##Productivity model##
model.prod.successor2 <- glm(SuccessorKnower ~ Productivity + Age.c, family = "binomial",
                              data = distinct_model.df)

##EXPLORATORY## - GAIN SCORE
model.gain.successor2 <- glm(SuccessorKnower ~ prod.gradient.c + Age.c, family = "binomial",
                              data = distinct_model.df)

##Regression table for Successor Knower Models (Table 2)
mtable.sf.knowers2 <- mtable('Base' = base.successor2,
            'IHC' = model.ihc.successor2,
            'NN' = model.nn.successor2,
            'Productivity' = model.prod.successor2,
            'Exp. - Prod. gain' = model.gain.successor2,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))
mtable.sf.knowers2
write.mtable(mtable.sf.knowers2, file="graphs/table2-v2.txt")

###MODEL COMPARISONS##
#base v. IHC
anova(base.successor2, model.ihc.successor2, test = 'LRT') #IHC not significant

#Highest contiguous NN v. IHC
anova(base.successor2, model.nn.successor2, test = 'LRT')#NN not significant

#Productivity v. IHC
anova(base.successor2, model.prod.successor2, test = 'LRT')# n.s.

##Exploratory
anova(base.successor2, model.gain.successor2, test = 'LRT')# n.s.
```


## Endless Models
```{r}
#Base model
base.endless2 <- glm(EndlessKnower ~ Age.c, family = "binomial", 
                      data = distinct_model.df)

###IHC MODEL###
model.ihc.endless2 <- glm(EndlessKnower ~ IHC.c + Age.c, family = "binomial", 
                           data = distinct_model.df)

###HIGHEST CONTIG NN MODEL###
model.nn.endless2 <- glm(EndlessKnower ~ wcnscore.c + Age.c, family = "binomial", 
                          data = distinct_model.df) 

###PRODUCTIVITY MODEL###
model.prod.endless2 <- glm(EndlessKnower ~ Productivity + Age.c, family = "binomial", 
                            data = distinct_model.df)

##EXPLORATORY## - GAIN SCORE
model.gain.endless2 <- glm(EndlessKnower ~ prod.gradient.c + Age.c, family = "binomial", 
                          data = distinct_model.df)

##Regression table for Endless Models
mtable.endless.knowers2 <- mtable('Base' = base.endless,
            'IHC' = model.ihc.endless,
            'NN' = model.nn.endless,
            'Productivity' = model.prod.endless,
            'Prod. gradient' = model.gain.endless,
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','F','p','N'))

mtable.endless.knowers2
write.mtable(mtable.endless.knowers2, file="graphs/table3-v2.txt")

##SIMPLE MODEL COMPARISONS##
#base v. IHC
anova(base.endless2, model.ihc.endless2, test = 'LRT') #IHC significant

#base v. highest contiguous
anova(model.nn.endless2, base.endless2, test = 'LRT')#NN significant

#base v. productivity
anova(model.prod.endless2, base.endless2, test = 'LRT')#Prod significant

##Exploratory base v. productivity gradient
anova(base.endless2, model.gain.endless2, test = 'LRT')# prod. gradient significant (better than IHC)

# #okay with about mean NN
# model2.endless <- glmer(EndlessKnower ~ mean.NN + Age + (1|LadlabID), family = "binomial", 
#                         data = distinct_model.df)
# anova(model2.endless, base.endless, test = 'LRT')#mean NN significant
```

### Endless: Large model comparison
Put all significant Endless predictors into large model, run model comparison

```{r}
##BASE MODEL WITH IHC
large.endless.base2 <- glm(EndlessKnower ~ IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)
##add highest contig
large.endless.nn2 <- glm(EndlessKnower ~ wcnscore.c + IHC.c + Age.c, 
                          family = "binomial", data = distinct_model.df)

##Productivity + IHC
large.endless.prod2 <- glm(EndlessKnower ~ Productivity + IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)

##Prod. Gain + IHC
large.endless.gain.ihc2 <- glm(EndlessKnower ~ IHC.c + prod.gradient.c + Age.c, 
                              family = "binomial", data = distinct_model.df)
#summary(large.endless.gain.ihc) #with addition of IHC, prod.gradient is marginal, AIC very slightly decreases

##ALL THREE TOGETHER
large.endless.full2 <- glm(EndlessKnower ~ Productivity + wcnscore.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)

##ALL THREE (productivity gradient)
large.endless.full.grad2 <- glm(EndlessKnower ~ prod.gradient.c + wcnscore.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)


##MODEL COMPARISONS
#IHC v. Highest contig.
anova(large.endless.base2, large.endless.nn2, test = 'LRT')#add NN n.s.

#IHC v. Productivity
anova(large.endless.base2, large.endless.prod2, test = 'LRT')#Productivity NS

#IHC v. Prod. Gain
anova(large.endless.base2, large.endless.gain.ihc2, test = 'LRT') #n.s. addition of gradient to ihc
anova(model.gain.endless2, large.endless.gain.ihc2, test = 'LRT') #n.s. addition of ihc to gradient.
```

### Endless: regression table
```{r}
mtable.endless.large2 <- mtable(#'IHC alone' = large.endless.base,
            'HCNN + IHC' = large.endless.nn,
            'Prod.Group + IHC' = large.endless.prod,
#            'Prod.Group + Highest contig. + IHC' = large.endless.full,
#            'Prod.Gradient alone' = model.gain.endless,
            'Prod.Gradient + IHC' = large.endless.gain.ihc,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))

mtable.endless.large2
write.mtable(mtable.endless.large2, file="graphs/table3b-v2.txt")
```
 
 
## LM predicting IHC from NN accuracy and age
```{r}
lm3 <- lm(IHC ~ wcnscore + Age.c, data = distinct_model.df)
summary(lm3)
```

## Full Infinity Knowledge models
### build models
```{r}
# Add full infinity knowledge classification to data frame
distinct_model.df <- distinct_model.df %>%
  mutate(InfinityKnower = factor(
    case_when(SuccessorKnower==0 | EndlessKnower==0 ~ 0,
              SuccessorKnower==1 & EndlessKnower==1 ~ 1),
    levels=c(0,1))
  )

###MODEL BUILDING AND COMPARISONS###
#base model for successor knower
base.infinity2 <- glm(InfinityKnower ~ Age.c, family = "binomial", 
                        data = distinct_model.df)

##IHC model
model.ihc.infinity2 <- glm(InfinityKnower ~ IHC.c + Age.c, family = "binomial", 
                             data = distinct_model.df)
##Highest NN Model
model.nn.infinity2 <- glm(InfinityKnower ~ wcnscore.c + Age.c, family = "binomial", 
                            data = distinct_model.df)
##Productivity model
model.prod.infinity2 <- glm(InfinityKnower ~ Productivity + Age.c, family = "binomial",
                              data = distinct_model.df)

##Gain Score model
model.gain.infinity2 <- glm(InfinityKnower ~ prod.gradient.c + Age.c, family = "binomial",
                              data = distinct_model.df)

##Regression table for Infinity Knower Models (Table 4)
mtable.inf.knowers2 <- mtable('Base' = base.infinity2,
            'IHC' = model.ihc.infinity2,
            'NN' = model.nn.infinity2,
            'Prod. Group' = model.prod.infinity2,
            'Prod. Gain' = model.gain.infinity2,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))
mtable.inf.knowers2
# save as txt
write.mtable(mtable.inf.knowers2, file="graphs/table4-v2.txt")
```

### Simple comparison
```{r}
#base v. IHC
anova(base.infinity2, model.ihc.infinity2, test = 'LRT') #n.s.

#base v. highest contiguous
anova(base.infinity2, model.nn.infinity2, test = 'LRT')# significant.

#base v. productivity
anova(base.infinity2, model.prod.infinity2, test = 'LRT')#n.s. 

#base v. productivity gradient
anova(base.infinity2, model.gain.infinity2, test = 'LRT')#n.s.
```

## Visualizations
```{r}
large.successor.full.grad2 <- glm(SuccessorKnower ~ prod.gradient.c + wcnscore.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)
large.inf.full.grad2 <- glm(InfinityKnower ~ prod.gradient.c + wcnscore.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df)

# maximal endless model
plot_model(large.endless.full.grad2, type="std", transform="plogis",
           title="'Numbers do not end'",
           show.values = TRUE, colors="blue", value.offset = .2,
           axis.labels = c("Age.c"="Age", "wcnscore.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-endless2.png', width=6, height=3.5)

# maximal successor model
plot_model(large.successor.full.grad2, type="std", transform="plogis",
           title="'Can always add one'",
           show.values = TRUE, colors="blue",value.offset = .2,
           axis.labels = c("Age.c"="Age", "wcnscore.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-successor2.png', width=6, height=3.5)

# maximal infinity model
plot_model(large.inf.full.grad2, type="std", transform="plogis",
           title="Full infinity knowledge",
           show.values = TRUE, colors="blue",value.offset = .2,
           axis.labels = c("Age.c"="Age", "wcnscore.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-fullinfinity2.png', width=6, height=3.5)
```

# Regressions no ihc=99

## prep
```{r}
distinct_model.df2 <- model.df %>%
  distinct(LadlabID, Age, AgeGroup, Gender, SuccessorKnower, EndlessKnower, 
           IHC, Highest_Contig_NN, FHC, DCE, Productivity, Productivity.tertiary, prod.gradient, wcnscore)%>%
  filter(IHC<99) %>%
  mutate(SuccessorKnower = factor(SuccessorKnower, levels = c(0,1)), 
         EndlessKnower = factor(EndlessKnower, levels = c(0,1)),
         IHC = as.integer(IHC), 
         Highest_Contig_NN = as.integer(Highest_Contig_NN), 
         LadlabID = factor(LadlabID), 
         IHC.c = as.vector(scale(IHC, center = TRUE, scale=TRUE)), #scale and center for model fit
         FHC.c = as.vector(scale(FHC, center = TRUE, scale=TRUE)),
         Highest_Contig_NN.c = as.vector(scale(Highest_Contig_NN, center = TRUE, scale=TRUE)), 
         Age.c = as.vector(scale(Age, center = TRUE, scale=TRUE)),
         prod.gradient.c = as.vector(scale(prod.gradient, center=TRUE, scale=TRUE)),
          wcnscore.c = as.vector(scale(wcnscore, center = TRUE, scale=TRUE))) %>%
  mutate(InfinityKnower = factor(
    case_when(SuccessorKnower==0 | EndlessKnower==0 ~ 0,
              SuccessorKnower==1 & EndlessKnower==1 ~ 1),
    levels=c(0,1))
  )
```

## Successor models
```{r}
###MODEL BUILDING AND COMPARISONS###
#base model for successor knower
base.successor3 <- glm(SuccessorKnower ~ Age.c, family = "binomial", 
                        data = distinct_model.df2)

##IHC model##
model.ihc.successor3 <- glm(SuccessorKnower ~ IHC.c + Age.c, family = "binomial", 
                             data = distinct_model.df2)
##Highest NN Model##
model.nn.successor3 <- glm(SuccessorKnower ~ wcnscore.c + Age.c, family = "binomial", 
                            data = distinct_model.df2)
##Productivity model##
model.prod.successor3 <- glm(SuccessorKnower ~ Productivity + Age.c, family = "binomial",
                              data = distinct_model.df2)

##EXPLORATORY## - GAIN SCORE
model.gain.successor3 <- glm(SuccessorKnower ~ prod.gradient.c + Age.c, family = "binomial",
                              data = distinct_model.df2)

##Regression table for Successor Knower Models (Table 2)
mtable.sf.knowers3 <- mtable('Base' = base.successor3,
            'IHC' = model.ihc.successor3,
            'NN' = model.nn.successor3,
            'Productivity' = model.prod.successor3,
            'Exp. - Prod. gain' = model.gain.successor3,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))
mtable.sf.knowers3
write.mtable(mtable.sf.knowers3, file="graphs/table2-v3.txt")

###MODEL COMPARISONS##
#base v. IHC
anova(base.successor3, model.ihc.successor3, test = 'LRT') #IHC significant

#Highest contiguous NN v. base
anova(base.successor3, model.nn.successor3, test = 'LRT')#NN not significant

#Productivity v. base
anova(base.successor3, model.prod.successor3, test = 'LRT')# n.s.

##Exploratory vs. base
anova(base.successor3, model.gain.successor3, test = 'LRT')# n.s.
```


## Endless Models
```{r}
#Base model
base.endless3 <- glm(EndlessKnower ~ Age.c, family = "binomial", 
                      data = distinct_model.df2)

###IHC MODEL###
model.ihc.endless3 <- glm(EndlessKnower ~ IHC.c + Age.c, family = "binomial", 
                           data = distinct_model.df2)

###HIGHEST CONTIG NN MODEL###
model.nn.endless3 <- glm(EndlessKnower ~ wcnscore.c + Age.c, family = "binomial", 
                          data = distinct_model.df2) 

###PRODUCTIVITY MODEL###
model.prod.endless3 <- glm(EndlessKnower ~ Productivity + Age.c, family = "binomial", 
                            data = distinct_model.df2)

##EXPLORATORY## - GAIN SCORE
model.gain.endless3 <- glm(EndlessKnower ~ prod.gradient.c + Age.c, family = "binomial", 
                          data = distinct_model.df2)

##Regression table for Endless Models
mtable.endless.knowers3 <- mtable('Base' = base.endless3,
            'IHC' = model.ihc.endless3,
            'NN' = model.nn.endless3,
            'Productivity' = model.prod.endless3,
            'Prod. gradient' = model.gain.endless3,
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','F','p','N'))

mtable.endless.knowers3
write.mtable(mtable.endless.knowers3, file="graphs/table3-v3.txt")

##SIMPLE MODEL COMPARISONS##
#base v. IHC
anova(base.endless3, model.ihc.endless3, test = 'LRT') #IHC not significant

#base v. highest contiguous
anova(model.nn.endless3, base.endless3, test = 'LRT')#not significant

#base v. productivity
anova(model.prod.endless3, base.endless3, test = 'LRT')#Prod significant

##Exploratory base v. productivity gradient
anova(base.endless3, model.gain.endless3, test = 'LRT')# prod. gradient significant
```


## Full Infinity Knowledge models
```{r}
###MODEL BUILDING AND COMPARISONS###
#base model for successor knower
base.infinity3 <- glm(InfinityKnower ~ Age.c, family = "binomial", 
                        data = distinct_model.df2)

##IHC model
model.ihc.infinity3 <- glm(InfinityKnower ~ IHC.c + Age.c, family = "binomial", 
                             data = distinct_model.df2)
##Highest NN Model
model.nn.infinity3 <- glm(InfinityKnower ~ wcnscore.c + Age.c, family = "binomial", 
                            data = distinct_model.df2)
##Productivity model
model.prod.infinity3 <- glm(InfinityKnower ~ Productivity + Age.c, family = "binomial",
                              data = distinct_model.df2)

##Gain Score model
model.gain.infinity3 <- glm(InfinityKnower ~ prod.gradient.c + Age.c, family = "binomial",
                              data = distinct_model.df2)

##Regression table for Infinity Knower Models (Table 4)
mtable.inf.knowers3 <- mtable('Base' = base.infinity3,
            'IHC' = model.ihc.infinity3,
            'NN' = model.nn.infinity3,
            'Prod. Group' = model.prod.infinity3,
            'Prod. Gain' = model.gain.infinity3,
            #summary.stats = c('R-squared','F','p','N'))
            summary.stats = c('Nagelkerke R-sq.','Log-likelihood','AIC','N'))
mtable.inf.knowers3
# save as txt
write.mtable(mtable.inf.knowers3, file="graphs/table4-v3.txt")


## comparisons
#base v. IHC
anova(base.infinity3, model.ihc.infinity3, test = 'LRT') #n.s.

#base v. highest contiguous
anova(base.infinity3, model.nn.infinity3, test = 'LRT')# n.s.

#base v. productivity
anova(base.infinity3, model.prod.infinity3, test = 'LRT')#n.s. 

#base v. productivity gradient
anova(base.infinity3, model.gain.infinity3, test = 'LRT')#n.s.
```

## Visualizations
```{r}
large.endless.full.grad3 <- glm(EndlessKnower ~ prod.gradient.c + wcnscore.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df2)
large.successor.full.grad3 <- glm(SuccessorKnower ~ prod.gradient.c + wcnscore.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df2)
large.inf.full.grad3 <- glm(InfinityKnower ~ prod.gradient.c + wcnscore.c + 
                              IHC.c + Age.c, 
                            family = "binomial", data = distinct_model.df2)

# maximal endless model
plot_model(large.endless.full.grad3, type="std", transform="plogis",
           title="'Numbers do not end', exclude errorless kids",
           show.values = TRUE, colors="blue", value.offset = .2,
           axis.labels = c("Age.c"="Age", "wcnscore.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-endless3.png', width=6, height=3.5)

# maximal successor model
plot_model(large.successor.full.grad3, type="std", transform="plogis",
           title="'Can always add one', exclude errorless kids",
           show.values = TRUE, colors="blue",value.offset = .2,
           axis.labels = c("Age.c"="Age", "wcnscore.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-successor3.png', width=6, height=3.5)

# maximal infinity model
plot_model(large.inf.full.grad3, type="std", transform="plogis",
           title="Full infinity knowledge, exclude errorless kids",
           show.values = TRUE, colors="blue",value.offset = .2,
           axis.labels = c("Age.c"="Age", "wcnscore.c"="Next Number accuracy",
                           "IHC.c"= "Initial Highest Count",
                           "prod.gradient.c"="Productivity Gradient",
                           "Probabilities"="Endorsement Probability")) +
  ggplot2::geom_hline(yintercept = 0.5, linetype="dashed")
ggsave('graphs/regression-fullinfinity3.png', width=6, height=3.5)
```